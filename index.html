<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronometragem - Cadastro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; }
        .card { max-width: 450px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        img { width: 180px; margin-bottom: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save { background-color: #28a745; color: white; border: none; }
        .btn-save:hover { background-color: #218838; }
        .btn-clear { background-color: #dc3545; color: white; border: none; font-size: 12px; margin-top: 30px; }
        .btn-nav { background-color: #007bff; color: white; border: none; }
        .btn-pdf { background-color: #27ae60; color: white; border: none; }
        .btn-pdf:hover { background-color: #219150; }
    </style>
</head>
<body>

    <div class="card">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s" alt="Logo">
        
        <input type="text" id="etapa" placeholder="Nome da Etapa (ex: GP Brasil)" oninput="salvarEtapaLocal()">
        
        <select id="categoria">
            <option value="PRODUCTION">PRODUCTION</option>
            <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
            <option value="PROTOTIPO">PROTOTIPO</option>
            <option value="UTV">UTV</option>
            <option value="INICIANTE">INICIANTE</option>
        </select>

        <input type="text" id="piloto" placeholder="Nome do Piloto" style="text-transform: uppercase;">
        
        <input type="text" id="tempo" placeholder="Tempo (MinSegMil) ex: 0105123" maxlength="9">

        <button class="btn-save" onclick="enviarDados()">SALVAR VOLTA</button>
        
        <hr>
        <button class="btn-nav" onclick="window.location.href='alteracao.html'">IR PARA ALTERAÇÃO</button>
        <button class="btn-nav" onclick="window.location.href='resultados.html'" style="background-color: #6c757d;">VER RESULTADOS</button>
        
        <button class="btn-pdf" onclick="exportarPDF()">EXPORTAR PDF GERAL</button>
        
        <button class="btn-clear" onclick="limparBanco()">LIMPAR TODOS OS DADOS (SENHA)</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4ajZM_W0_qGOlrlRoPn6DUsUBUm4qAcc",
            authDomain: "crono-rrb.firebaseapp.com",
            databaseURL: "https://crono-rrb-default-rtdb.firebaseio.com",
            projectId: "crono-rrb",
            storageBucket: "crono-rrb.firebasestorage.app",
            messagingSenderId: "1472207720",
            appId: "1:1472207720:web:11502aed4117b1fda714dd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        if(localStorage.getItem('etapaFixa')) {
            document.getElementById('etapa').value = localStorage.getItem('etapaFixa');
        }
        function salvarEtapaLocal() {
            localStorage.setItem('etapaFixa', document.getElementById('etapa').value);
        }

        document.getElementById('tempo').addEventListener('input', function (e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 4) {
                v = v.replace(/(\d{2})(\d{2})(\d{3})/, "$1:$2:$3");
            } else if (v.length > 2) {
                v = v.replace(/(\d{2})(\d{2})/, "$1:$2");
            }
            e.target.value = v;
        });

        async function enviarDados() {
            const etapa = document.getElementById('etapa').value;
            const categoria = document.getElementById('categoria').value;
            const piloto = document.getElementById('piloto').value.trim().toUpperCase();
            const tempo = document.getElementById('tempo').value;

            if (!etapa || !piloto || tempo.length < 9) {
                alert("Por favor, preencha todos os campos. O tempo deve ter o formato 00:00:000");
                return;
            }

            const idPiloto = btoa(categoria + "_" + piloto).replace(/=/g, ""); 
            const ref = db.ref('pilotos/' + idPiloto);

            const snapshot = await ref.once('value');
            const pData = snapshot.val();

            if (!pData) {
                await ref.set({
                    categoria: categoria,
                    piloto: piloto,
                    volta1: tempo,
                    volta2: "00:00:000"
                });
                alert("Volta 1 salva!");
            } else {
                if (pData.volta2 === "00:00:000") {
                    await ref.update({ volta2: tempo });
                    alert("Volta 2 salva!");
                } else {
                    alert("Este piloto já possui as 2 voltas registradas nesta categoria!");
                }
            }
            document.getElementById('tempo').value = "";
        }

        // FUNÇÕES PARA EXPORTAÇÃO PDF NO INDEX
        function tParaMs(t) {
            if (!t || t === "00:00:000") return 0;
            const p = t.split(':');
            return (parseInt(p[0]) * 60000) + (parseInt(p[1]) * 1000) + parseInt(p[2]);
        }

        function msParaT(ms) {
            if (ms === 0) return "00:00:000";
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            const mil = ms % 1000;
            return `${String(min).padStart(2,'0')}:${String(seg).padStart(2,'0')}:${String(mil).padStart(3,'0')}`;
        }

        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const logo = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s";
            
            const snapshot = await db.ref('pilotos').once('value');
            const data = snapshot.val();
            if (!data) { alert("Não há dados para exportar."); return; }

            let listaPilotos = [];
            for (let k in data) {
                const p = data[k];
                const soma = tParaMs(p.volta1) + tParaMs(p.volta2);
                listaPilotos.push({ ...p, totalMs: soma, totalStr: msParaT(soma) });
            }

            const img = new Image();
            img.src = logo;
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                const etapa = localStorage.getItem('etapaFixa') || "Geral";
                doc.addImage(img, 'PNG', 10, 10, 30, 30);
                doc.setFontSize(16);
                doc.text(`RANKING - ${etapa}`, 45, 20);
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString()}`, 45, 28);
                
                let y = 50;
                const cats = ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"];
                cats.forEach(cat => {
                    let filtrados = listaPilotos.filter(p => p.categoria === cat).sort((a,b) => a.totalMs - b.totalMs);
                    if (filtrados.length > 0) {
                        doc.setFontSize(12);
                        doc.text(`Categoria: ${cat}`, 10, y);
                        const rows = filtrados.map((p, i) => [`${i+1}º`, p.piloto, p.volta1, p.volta2, p.totalStr]);
                        doc.autoTable({
                            startY: y + 5,
                            head: [['Pos', 'Piloto', 'Volta 1', 'Volta 2', 'Total']],
                            body: rows,
                            theme: 'grid',
                            headStyles: { fillColor: [40, 40, 40] }
                        });
                        y = doc.lastAutoTable.finalY + 15;
                    }
                });
                doc.save(`Resultado_${etapa}.pdf`);
            };
        }

        function limparBanco() {
            const senha = prompt("Digite a senha para APAGAR TUDO:");
            if (senha === "123456") {
                db.ref('pilotos').remove()
                    .then(() => alert("Todos os dados foram apagados com sucesso!"))
                    .catch((e) => alert("Erro ao apagar: " + e));
            } else {
                alert("Senha incorreta!");
            }
        }
    </script>
</body>
</html>