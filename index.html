<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastro - Cronometragem</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        .header { text-align: center; margin-bottom: 20px; }
        .logo { width: 150px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        input, select, button { padding: 12px; width: 100%; box-sizing: border-box; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .grid-tempo { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .btn-limpar { background: #ff4444; color: white; border: none; cursor: pointer; margin-top: 20px; font-weight: bold; }
        .nav-btn { background: #2196F3; color: white; border: none; margin-bottom: 10px; cursor: pointer; font-weight: bold; }
        .btn-pdf { background: #333; color: white; border: none; cursor: pointer; margin-bottom: 20px; font-weight: bold; }
        .btn-save { background: #4CAF50; color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="header">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s" alt="Logo" class="logo">
    <h2 id="displayEtapa">Painel de Controle</h2>
</div>

<div class="container">
    <button class="nav-btn" onclick="window.open('resultados.html', '_blank')">PAINEL</button>
    <button class="btn-pdf" onclick="gerarPDF()">GERAR RELATORIO</button>

    <hr>

    <div class="form-group">
        <label>Nome da Etapa:</label>
        <input type="text" id="etapa" placeholder="Ex: Etapa 01 - Rally" onchange="fixarEtapa()">
    </div>

    <div class="form-group">
        <label>Categoria:</label>
        <select id="categoria">
            <option value="PRODUCTION">PRODUCTION</option>
            <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
            <option value="PROTOTIPO">PROTOTIPO</option>
            <option value="UTV">UTV</option>
            <option value="INICIANTE">INICIANTE</option>
        </select>
    </div>

    <div class="form-group">
        <label>Nome do Piloto:</label>
        <input type="text" id="piloto" placeholder="Nome do Piloto">
    </div>

    <div class="form-group">
        <label>Tempo da Volta (Min : Seg : Mil):</label>
        <div class="grid-tempo">
            <input type="number" id="min" placeholder="00" min="0">
            <input type="number" id="seg" placeholder="00" min="0" max="59">
            <input type="number" id="mil" placeholder="000" min="0" max="999">
        </div>
        <button class="btn-save" onclick="salvarVolta()">REGISTRAR VOLTA</button>
    </div>

    <button class="btn-limpar" onclick="limparDados()">LIMPAR TUDO</button>
</div>

<script>
    // Lógica compartilhada via LocalStorage
    let dados = JSON.parse(localStorage.getItem('corrida_dados')) || [];
    let etapaFixa = localStorage.getItem('etapa_fixa') || "";
    document.getElementById('etapa').value = etapaFixa;
    if(etapaFixa) document.getElementById('displayEtapa').innerText = etapaFixa;

    function fixarEtapa() {
        const val = document.getElementById('etapa').value;
        localStorage.setItem('etapa_fixa', val);
        document.getElementById('displayEtapa').innerText = val;
    }

    function salvarVolta() {
        const piloto = document.getElementById('piloto').value.trim().toUpperCase();
        const categoria = document.getElementById('categoria').value;
        const m = parseInt(document.getElementById('min').value) || 0;
        const s = parseInt(document.getElementById('seg').value) || 0;
        const ms = parseInt(document.getElementById('mil').value) || 0;

        if (!piloto) return alert("Informe o piloto!");

        const tempoTotalMs = (m * 60000) + (s * 1000) + ms;
        let index = dados.findIndex(p => p.nome === piloto && p.categoria === categoria);

        if (index === -1) {
            dados.push({ nome: piloto, categoria: categoria, volta1: tempoTotalMs, volta2: null, total: tempoTotalMs });
        } else {
            if (dados[index].volta2 === null) {
                dados[index].volta2 = tempoTotalMs;
                dados[index].total = dados[index].volta1 + tempoTotalMs;
            } else {
                return alert("Piloto já possui 2 voltas!");
            }
        }

        localStorage.setItem('corrida_dados', JSON.stringify(dados));
        alert("Registrado!");
        document.getElementById('piloto').value = "";
        document.getElementById('min').value = ""; document.getElementById('seg').value = ""; document.getElementById('mil').value = "";
    }

    function limparDados() {
        if(prompt("Senha:") === "123456") {
            localStorage.clear();
            location.reload();
        }
    }

    // Função PDF (Mantida conforme solicitado na Home)
    async function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const dataHora = new Date().toLocaleString();
        const etapa = localStorage.getItem('etapa_fixa') || "Etapa";
        const imgUrl = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s";
        
        doc.addImage(imgUrl, 'PNG', 10, 10, 20, 20);
        doc.text(etapa, 50, 20);
        doc.text(`${dataHora}`, 50, 28);

        
        const categorias = ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"];
        let y = 40;
        categorias.forEach(cat => {
            let filtrados = dados.filter(d => d.categoria === cat).sort((a,b) => a.total - b.total);
            if(filtrados.length > 0) {
                doc.text(cat, 10, y);
                doc.autoTable({
                    startY: y + 5,
                    head: [['Pos', 'Piloto', 'V1', 'V2', 'Total']],
                    body: filtrados.map((p, i) => [`${i+1}º`, p.nome, formatarTempo(p.volta1), formatarTempo(p.volta2), formatarTempo(p.total)])
                });
                y = doc.lastAutoTable.finalY + 10;
            }
        });
        doc.save("ranking.pdf");
    }

    function formatarTempo(ms) {
        if (!ms) return "--:--:---";
        let min = Math.floor(ms / 60000);
        let seg = Math.floor((ms % 60000) / 1000);
        let mil = ms % 1000;
        return `${min.toString().padStart(2, '0')}:${seg.toString().padStart(2, '0')}:${mil.toString().padStart(3, '0')}`;
    }
</script>
</body>
</html>