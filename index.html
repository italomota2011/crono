<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronometragem - Cadastro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; }
        .card { max-width: 450px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        img { width: 180px; margin-bottom: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save { background-color: #28a745; color: white; border: none; }
        .btn-save:hover { background-color: #218838; }
        .btn-pdf { background-color: #27ae60; color: white; border: none; }
        .btn-nav { background-color: #007bff; color: white; border: none; }
        .btn-clear { background-color: #dc3545; color: white; border: none; font-size: 12px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="card">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s" alt="Logo">
        
        <input type="text" id="etapa" placeholder="Nome da Etapa (Ex: GP Brasil)">
        
        <select id="categoria">
            <option value="PRODUCTION">PRODUCTION</option>
            <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
            <option value="PROTOTIPO">PROTOTIPO</option>
            <option value="UTV">UTV</option>
            <option value="INICIANTE">INICIANTE</option>
        </select>

        <input type="text" id="piloto" placeholder="Nome do Piloto" style="text-transform: uppercase;">
        <input type="text" id="tempo" placeholder="Tempo (00:00:000)" maxlength="9">

        <button class="btn-save" onclick="enviarDados()">SALVAR VOLTA</button>
        <button class="btn-pdf" onclick="exportarPDF()">EXPORTAR PDF GERAL</button>
        <hr>
        <button class="btn-nav" onclick="window.location.href='alteracao.html'">IR PARA ALTERAÇÃO</button>
        <button class="btn-nav" onclick="window.location.href='resultados.html'" style="background-color: #6c757d;">VER RESULTADOS</button>
        
        <button class="btn-clear" onclick="limparBanco()">LIMPAR TUDO (SENHA)</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4ajZM_W0_qGOlrlRoPn6DUsUBUm4qAcc",
            authDomain: "crono-rrb.firebaseapp.com",
            databaseURL: "https://crono-rrb-default-rtdb.firebaseio.com",
            projectId: "crono-rrb",
            storageBucket: "crono-rrb.firebasestorage.app",
            messagingSenderId: "1472207720",
            appId: "1:1472207720:web:11502aed4117b1fda714dd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Máscara de tempo
        document.getElementById('tempo').addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 4) v = v.replace(/(\d{2})(\d{2})(\d{3})/, "$1:$2:$3");
            else if (v.length > 2) v = v.replace(/(\d{2})(\d{2})/, "$1:$2");
            e.target.value = v;
        });

        // Carrega etapa salva anteriormente
        db.ref('configuracao/nomeEtapa').once('value', snap => {
            if(snap.exists()) document.getElementById('etapa').value = snap.val();
        });

        async function enviarDados() {
            const etapa = document.getElementById('etapa').value.trim();
            const categoria = document.getElementById('categoria').value;
            const piloto = document.getElementById('piloto').value.trim().toUpperCase();
            const tempo = document.getElementById('tempo').value;

            if (!etapa || !piloto || tempo.length < 9) {
                alert("Preencha tudo corretamente!"); return;
            }

            // SALVA A ETAPA NO BANCO (CRUCIAL)
            await db.ref('configuracao').update({ nomeEtapa: etapa });

            const idPiloto = btoa(categoria + "_" + piloto).replace(/=/g, ""); 
            const ref = db.ref('pilotos/' + idPiloto);
            const snap = await ref.once('value');
            const pData = snap.val();

            if (!pData) {
                await ref.set({ categoria, piloto, volta1: tempo, volta2: "00:00:000" });
                alert("Volta 1 salva!");
            } else if (pData.volta2 === "00:00:000") {
                await ref.update({ volta2: tempo });
                alert("Volta 2 salva!");
            } else {
                alert("Piloto já tem as 2 voltas!");
            }
            document.getElementById('tempo').value = "";
        }

        function tParaMs(t) {
            if (!t || t === "00:00:000") return 0;
            const p = t.split(':');
            return (parseInt(p[0]) * 60000) + (parseInt(p[1]) * 1000) + parseInt(p[2]);
        }

        function msParaT(ms) {
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            const mil = ms % 1000;
            return `${String(min).padStart(2,'0')}:${String(seg).padStart(2,'0')}:${String(mil).padStart(3,'0')}`;
        }

        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // BUSCA A ETAPA DIRETO DO FIREBASE ANTES DE GERAR
            const snapEtapa = await db.ref('configuracao/nomeEtapa').once('value');
            const etapaTitulo = snapEtapa.val() || document.getElementById('etapa').value || "Geral";

            const snapshot = await db.ref('pilotos').once('value');
            const data = snapshot.val();
            if (!data) return alert("Sem dados!");

            let lista = [];
            for (let k in data) {
                const p = data[k];
                const soma = tParaMs(p.volta1) + tParaMs(p.volta2);
                lista.push({ ...p, totalMs: soma, totalStr: msParaT(soma) });
            }

            const img = new Image();
            img.src = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s";
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                doc.addImage(img, 'PNG', 10, 10, 30, 30);
                doc.setFontSize(18);
                doc.text("RELATÓRIO DE RESULTADOS", 45, 22);
                doc.setFontSize(12);
                doc.text(`Etapa: ${etapaTitulo}`, 45, 30); // AQUI APARECERÁ A ETAPA
                
                let y = 50;
                ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"].forEach(cat => {
                    let filtri = lista.filter(p => p.categoria === cat).sort((a,b) => a.totalMs - b.totalMs);
                    if (filtri.length > 0) {
                        doc.setFontSize(14);
                        doc.text(`Categoria: ${cat}`, 10, y);
                        doc.autoTable({
                            startY: y + 5,
                            head: [['Pos', 'Piloto