<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking em Tempo Real</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .header-container { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .qr-code { width: 90px; height: 90px; }
        .etapa-titulo { font-size: 24px; font-weight: bold; color: #333; margin: 0; text-transform: uppercase; }
        .refresh-info { color: #e74c3c; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        th { background: #343a40; color: white; }
        h3 { border-left: 5px solid #27ae60; padding-left: 10px; color: #2c3e50; margin-top: 30px; }
        .empty-msg { text-align: center; padding: 20px; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div class="header-container">
        <div>
            <p class="etapa-titulo" id="displayEtapa">CARREGANDO ETAPA...</p>
            <p id="dataRelatorio" style="color: #666;"></p>
        </div>
        <div style="text-align: right;">
            <img src="https://raw.githubusercontent.com/italomota2011/crono/main/QR.png" class="qr-code">
            <div class="refresh-info">Atualiza em: <span id="countdown">5</span>s</div>
        </div>
    </div>

    <select id="filtroCat" onchange="renderizar()" style="padding: 10px; margin-bottom: 20px; width: 100%; max-width: 300px; border-radius: 5px;">
        <option value="TODAS">TODAS AS CATEGORIAS</option>
        <option value="PRODUCTION">PRODUCTION</option>
        <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
        <option value="PROTOTIPO">PROTOTIPO</option>
        <option value="UTV">UTV</option>
        <option value="INICIANTE">INICIANTE</option>
    </select>

    <div id="conteudoTabelas"></div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4ajZM_W0_qGOlrlRoPn6DUsUBUm4qAcc",
            authDomain: "crono-rrb.firebaseapp.com",
            databaseURL: "https://crono-rrb-default-rtdb.firebaseio.com",
            projectId: "crono-rrb",
            storageBucket: "crono-rrb.firebasestorage.app",
            messagingSenderId: "1472207720",
            appId: "1:1472207720:web:11502aed4117b1fda714dd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function tParaMs(t) {
            if (!t || t === "00:00:000") return 0;
            const p = t.split(':');
            return (parseInt(p[0]) * 60000) + (parseInt(p[1]) * 1000) + parseInt(p[2]);
        }

        function msParaT(ms) {
            if (ms === 0) return "00:00:000";
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            const mil = ms % 1000;
            return `${String(min).padStart(2,'0')}:${String(seg).padStart(2,'0')}:${String(mil).padStart(3,'0')}`;
        }

        async function renderizar() {
            // BUSCA NOME DA ETAPA
            try {
                const snapEtapa = await db.ref('configuracao/nomeEtapa').once('value');
                document.getElementById('displayEtapa').innerText = snapEtapa.val() || "ETAPA NÃO DEFINIDA";
            } catch (e) {
                console.error("Erro ao buscar etapa:", e);
            }

            document.getElementById('dataRelatorio').innerText = "Data: " + new Date().toLocaleDateString();

            // BUSCA PILOTOS
            db.ref('pilotos').once('value', snapshot => {
                const data = snapshot.val();
                let lista = [];
                if (data) {
                    for (let k in data) {
                        const p = data[k];
                        const soma = tParaMs(p.volta1) + tParaMs(p.volta2);
                        lista.push({ ...p, totalMs: soma });
                    }
                }

                const filtro = document.getElementById('filtroCat').value;
                const categoriasPadrao = ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"];
                const cats = filtro === "TODAS" ? categoriasPadrao : [filtro];
                
                let html = '';
                cats.forEach(cat => {
                    let filtri = lista.filter(p => p.categoria === cat).sort((a,b) => {
                        if (a.totalMs === 0) return 1;
                        if (b.totalMs === 0) return -1;
                        return a.totalMs - b.totalMs;
                    });

                    if (filtri.length > 0) {
                        html += `<h3>${cat}</h3><table><thead><tr><th>Pos</th><th>Piloto</th><th>V1</th><th>V2</th><th>Total</th></tr></thead><tbody>`;
                        filtri.forEach((p, i) => {
                            html += `<tr>
                                <td>${i+1}º</td>
                                <td>${p.piloto}</td>
                                <td>${p.volta1}</td>
                                <td>${p.volta2}</td>
                                <td><strong>${msParaT(p.totalMs)}</strong></td>
                            </tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                });
                document.getElementById('conteudoTabelas').innerHTML = html || "<p class='empty-msg'>Nenhum dado encontrado.</p>";
            });
        }

        let seg = 5;
        setInterval(() => {
            seg--; 
            document.getElementById('countdown').innerText = seg;
            if (seg <= 0) { 
                renderizar(); 
                seg = 5; 
            }
        }, 1000);

        window.onload = renderizar;
    </script>
</body>
</html>