<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC4ajZM_W0_qGOlrlRoPn6DUsUBUm4qAcc",
        authDomain: "crono-rrb.firebaseapp.com",
        databaseURL: "https://crono-rrb-default-rtdb.firebaseio.com",
        projectId: "crono-rrb",
        storageBucket: "crono-rrb.firebasestorage.app",
        messagingSenderId: "1472207720",
        appId: "1:1472207720:web:11502aed4117b1fda714dd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function tParaMs(t) {
        if (!t || t === "00:00:000") return 0;
        const p = t.split(':');
        return (parseInt(p[0]) * 60000) + (parseInt(p[1]) * 1000) + parseInt(p[2]);
    }

    function msParaT(ms) {
        if (ms === 0) return "00:00:000";
        const min = Math.floor(ms / 60000);
        const seg = Math.floor((ms % 60000) / 1000);
        const mil = ms % 1000;
        return `${String(min).padStart(2,'0')}:${String(seg).padStart(2,'0')}:${String(mil).padStart(3,'0')}`;
    }

    function renderizar() {
        const filtro = document.getElementById('filtroCat').value;
        
        // 1. Busca o nome da Etapa no Firebase
        db.ref('configuracoes/etapaAtual').once('value', snapshot => {
            document.getElementById('displayEtapa').innerText = snapshot.val() || "ETAPA NÃO DEFINIDA";
        });

        // 2. Busca os Pilotos no Firebase
        db.ref('pilotos').once('value', snapshot => {
            const data = snapshot.val();
            let lista = [];
            for (let k in data) {
                const p = data[k];
                const soma = tParaMs(p.volta1) + tParaMs(p.volta2);
                lista.push({ ...p, totalMs: soma, totalStr: msParaT(soma) });
            }

            const categorias = filtro === "TODAS" ? ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"] : [filtro];
            let html = '';

            categorias.forEach(cat => {
                let filtrados = lista.filter(p => p.categoria === cat).sort((a,b) => a.totalMs - b.totalMs);
                if (filtrados.length > 0) {
                    html += `<h3>CATEGORIA: ${cat}</h3>`;
                    html += `<table><thead><tr><th>Pos</th><th>Piloto</th><th>Volta 1</th><th>Volta 2</th><th>Total</th></tr></thead><tbody>`;
                    filtrados.forEach((p, i) => {
                        html += `<tr><td>${i+1}º</td><td>${p.piloto}</td><td>${p.volta1}</td><td>${p.volta2}</td><td><strong>${p.totalStr}</strong></td></tr>`;
                    });
                    html += `</tbody></table>`;
                }
            });

            document.getElementById('conteudoTabelas').innerHTML = html || "<p>Nenhum tempo registrado.</p>";
            document.getElementById('dataRelatorio').innerText = "Data: " + new Date().toLocaleDateString();
        });
    }

    let segundos = 5;
    setInterval(() => {
        segundos--;
        document.getElementById('countdown').innerText = segundos;
        if (segundos <= 0) {
            renderizar();
            segundos = 5;
        }
    }, 1000);

    window.onload = renderizar;
</script>