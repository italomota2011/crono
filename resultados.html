<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking em Tempo Real</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .header-container { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .qr-code { width: 90px; height: 90px; }
        .etapa-titulo { font-size: 24px; font-weight: bold; color: #333; margin: 0; }
        .refresh-info { color: #e74c3c; font-weight: bold; font-size: 14px; }
        
        select, .btn-pdf { padding: 10px 15px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; cursor: pointer; }
        .btn-pdf { background-color: #27ae60; color: white; border: none; font-weight: bold; margin-left: 10px; }
        .btn-pdf:hover { background-color: #219150; }

        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #343a40; color: white; text-transform: uppercase; font-size: 13px; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        h3 { color: #2c3e50; border-left: 5px solid #27ae60; padding-left: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="header-container">
        <div>
            <p class="etapa-titulo" id="displayEtapa">CARREGANDO ETAPA...</p>
            <p id="dataRelatorio" style="margin: 5px 0; color: #666;"></p>
        </div>
        <div style="text-align: right;">
            <img src="https://raw.githubusercontent.com/italomota2011/crono/main/QR.png" class="qr-code" alt="QR Code">
            <div class="refresh-info"><span id="countdown">5</span>s</div>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <select id="filtroCat" onchange="renderizar()">
            <option value="TODAS">TODAS AS CATEGORIAS</option>
            <option value="PRODUCTION">PRODUCTION</option>
            <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
            <option value="PROTOTIPO">PROTOTIPO</option>
            <option value="UTV">UTV</option>
            <option value="INICIANTE">INICIANTE</option>
        </select>
        <button class="btn-pdf" onclick="exportarPDF()">EXPORTAR PDF GERAL</button>
    </div>

    <div id="conteudoTabelas"></div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4ajZM_W0_qGOlrlRoPn6DUsUBUm4qAcc",
            authDomain: "crono-rrb.firebaseapp.com",
            databaseURL: "https://crono-rrb-default-rtdb.firebaseio.com",
            projectId: "crono-rrb",
            storageBucket: "crono-rrb.firebasestorage.app",
            messagingSenderId: "1472207720",
            appId: "1:1472207720:web:11502aed4117b1fda714dd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let listaPilotosGlobal = [];

        function tParaMs(t) {
            if (!t || t === "00:00:000") return 0;
            const p = t.split(':');
            return (parseInt(p[0]) * 60000) + (parseInt(p[1]) * 1000) + parseInt(p[2]);
        }

        function msParaT(ms) {
            if (ms === 0) return "00:00:000";
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            const mil = ms % 1000;
            return `${String(min).padStart(2,'0')}:${String(seg).padStart(2,'0')}:${String(mil).padStart(3,'0')}`;
        }

        function renderizar() {
            const filtro = document.getElementById('filtroCat').value;
            db.ref('pilotos').once('value', snapshot => {
                const data = snapshot.val();
                listaPilotosGlobal = [];
                for (let k in data) {
                    const p = data[k];
                    const soma = tParaMs(p.volta1) + tParaMs(p.volta2);
                    listaPilotosGlobal.push({ ...p, totalMs: soma, totalStr: msParaT(soma) });
                }

                const categorias = filtro === "TODAS" ? ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"] : [filtro];
                let html = '';

                categorias.forEach(cat => {
                    let filtrados = listaPilotosGlobal.filter(p => p.categoria === cat).sort((a,b) => a.totalMs - b.totalMs);
                    if (filtrados.length > 0) {
                        html += `<h3>CATEGORIA: ${cat}</h3>`;
                        html += `<table><thead><tr><th>Pos</th><th>Piloto</th><th>Volta 1</th><th>Volta 2</th><th>Total</th></tr></thead><tbody>`;
                        filtrados.forEach((p, i) => {
                            html += `<tr><td>${i+1}º</td><td>${p.piloto}</td><td>${p.volta1}</td><td>${p.volta2}</td><td><strong>${p.totalStr}</strong></td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                });

                document.getElementById('conteudoTabelas').innerHTML = html || "<p>Nenhum tempo registrado.</p>";
                document.getElementById('displayEtapa').innerText = localStorage.getItem('etapaFixa') || "RALLY 4X4";
                document.getElementById('dataRelatorio').innerText = "Data: " + new Date().toLocaleDateString();
            });
        }

        // Lógica de Atualização Automática
        let segundos = 5;
        setInterval(() => {
            segundos--;
            document.getElementById('countdown').innerText = segundos;
            if (segundos <= 0) {
                renderizar();
                segundos = 5;
            }
        }, 1000);

        // Exportação PDF
        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const logo = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s";
            
            const img = new Image();
            img.src = logo;
            img.crossOrigin = "Anonymous";

            img.onload = function() {
                const etapa = localStorage.getItem('etapaFixa') || "Geral";
                doc.addImage(img, 'PNG', 10, 10, 30, 30);
                doc.setFontSize(16);
                doc.text(`RANKING - ${etapa}`, 45, 20);
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString()}`, 45, 28);
                
                let y = 50;
                const cats = ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"];

                cats.forEach(cat => {
                    let filtrados = listaPilotosGlobal.filter(p => p.categoria === cat).sort((a,b) => a.totalMs - b.totalMs);
                    if (filtrados.length > 0) {
                        doc.setFontSize(12);
                        doc.text(`Categoria: ${cat}`, 10, y);
                        
                        const rows = filtrados.map((p, i) => [`${i+1}º`, p.piloto, p.volta1, p.volta2, p.totalStr]);
                        
                        doc.autoTable({
                            startY: y + 5,
                            head: [['Pos', 'Piloto', 'Volta 1', 'Volta 2', 'Total']],
                            body: rows,
                            theme: 'grid',
                            headStyles: { fillColor: [40, 40, 40] }
                        });
                        y = doc.lastAutoTable.finalY + 15;
                    }
                });
                doc.save(`Resultado_${etapa}.pdf`);
            };
        }

        window.onload = renderizar;
    </script>
</body>
</html>