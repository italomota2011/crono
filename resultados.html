<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Resultados em Tempo Real</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 1000px; margin: auto; position: relative; } /* Adicionado position relative */
        
        /* Estilo da Imagem do QR Code */
        .qr-code-header {
            position: absolute;
            top: 0;
            right: 0;
            width: 80px; /* Tamanho ajustável */
            height: auto;
            border: 2px solid #444;
            border-radius: 4px;
        }

        .header-info { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 10px; margin-bottom: 20px; padding-right: 90px; } /* Padding extra para não sobrepor o QR */
        
        .filter-section { margin-bottom: 20px; background: #2a2a2a; padding: 15px; border-radius: 5px; }
        select { padding: 10px; background: #333; color: white; border: 1px solid #2196F3; border-radius: 4px; width: 100%; max-width: 300px; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #2a2a2a; color: white; margin-bottom: 30px; }
        th, td { border: 1px solid #444; padding: 12px; text-align: left; }
        th { background-color: #2196F3; color: white; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #333; }
        .posicao { font-weight: bold; color: #ffeb3b; width: 50px; }
        .tempo-total { color: #4CAF50; font-weight: bold; }
        h2 { color: #2196F3; margin: 0; }
        h4 { background: #444; padding: 10px; margin: 0; border-left: 5px solid #2196F3; }
        #timer { font-size: 0.8em; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <img src="QR.png" alt="QR Code" class="qr-code-header">

    <div class="header-info">
        <h2 id="etapaNome">CARREGANDO ETAPA...</h2>
        <div id="timer"> <span id="segundos">5</span>s</div>
    </div>

    <div class="filter-section">
        <label for="filtroCategoria">Filtrar por Categoria:</label><br><br>
        <select id="filtroCategoria" onchange="atualizar()">
            <option value="TODAS">TODAS AS CATEGORIAS</option>
            <option value="PRODUCTION">PRODUCTION</option>
            <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
            <option value="PROTOTIPO">PROTOTIPO</option>
            <option value="UTV">UTV</option>
            <option value="INICIANTE">INICIANTE</option>
        </select>
    </div>

    <div id="listaResultados"></div>
</div>

<script>
    function formatarTempo(ms) {
        if (ms === null || ms === undefined) return "--:--:---";
        let min = Math.floor(ms / 60000);
        let seg = Math.floor((ms % 60000) / 1000);
        let mil = ms % 1000;
        return `${min.toString().padStart(2, '0')}:${seg.toString().padStart(2, '0')}:${mil.toString().padStart(3, '0')}`;
    }

    function atualizar() {
        const dados = JSON.parse(localStorage.getItem('corrida_dados')) || [];
        const etapa = localStorage.getItem('etapa_fixa') || "Etapa Não Definida";
        document.getElementById('etapaNome').innerText = etapa;

        const categoriaSelecionada = document.getElementById('filtroCategoria').value;
        const container = document.getElementById('listaResultados');
        container.innerHTML = "";
        
        const categoriasParaExibir = ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"];

        categoriasParaExibir.forEach(cat => {
            if (categoriaSelecionada !== "TODAS" && categoriaSelecionada !== cat) return;

            let filtrados = dados.filter(d => d.categoria === cat).sort((a, b) => a.total - b.total);
            
            if(filtrados.length === 0) {
                if (categoriaSelecionada === cat) {
                    container.innerHTML = "<p>Nenhum resultado encontrado para esta categoria.</p>";
                }
                return;
            }

            let html = `<h4>CATEGORIA: ${cat}</h4><table>
                <thead>
                    <tr><th>Pos</th><th>Piloto</th><th>Volta 1</th><th>Volta 2</th><th>Soma Total</th></tr>
                </thead>
                <tbody>`;
            
            filtrados.forEach((p, i) => {
                html += `<tr>
                    <td class="posicao">${i+1}º</td>
                    <td>${p.nome}</td>
                    <td>${formatarTempo(p.volta1)}</td>
                    <td>${formatarTempo(p.volta2)}</td>
                    <td class="tempo-total">${formatarTempo(p.total)}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML += html;
        });
    }

    let contagem = 5;
    setInterval(() => {
        contagem--;
        document.getElementById('segundos').innerText = contagem;
        if(contagem <= 0) {
            atualizar();
            contagem = 5;
        }
    }, 1000);

    window.onload = atualizar;
</script>

</body>
</html>