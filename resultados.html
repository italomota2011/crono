<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking em Tempo Real</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .header-container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        /* Estilização do QR Code no canto superior direito */
        .qr-container {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        .qr-code-img { 
            width: 100px; 
            height: 100px; 
            object-fit: contain;
            border: 1px solid #ddd;
            padding: 2px;
            background: #fff;
        }
        .etapa-titulo { font-size: 22px; font-weight: bold; margin: 0; }
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 30px; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        th { background-color: #343a40; color: white; }
        h3 { color: #2c3e50; border-left: 5px solid #27ae60; padding-left: 10px; }
    </style>
</head>
<body>
    <div class="header-container">
        <div>
            <p class="etapa-titulo" id="displayEtapa">CARREGANDO...</p>
            <p id="dataRelatorio" style="color: #666;"></p>
        </div>
        
        <div class="qr-container">
            <img src="https://raw.githubusercontent.com/italomota2011/crono/main/QR.png" alt="QR Code" class="qr-code-img">
            <div style="color: #e74c3c; font-weight: bold; font-size: 14px;"> 
                Atualizando em: <span id="countdown">5</span>s
            </div>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <select id="filtroCat" onchange="renderizar()" style="padding: 10px;">
            <option value="TODAS">TODAS AS CATEGORIAS</option>
            <option value="PRODUCTION">PRODUCTION</option>
            <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
            <option value="PROTOTIPO">PROTOTIPO</option>
            <option value="UTV">UTV</option>
            <option value="INICIANTE">INICIANTE</option>
        </select>
        <button onclick="exportarPDF()" style="padding: 10px; background: #27ae60; color: white; border: none; cursor: pointer;">PDF GERAL</button>
    </div>

    <div id="conteudoTabelas"></div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4ajZM_W0_qGOlrlRoPn6DUsUBUm4qAcc",
            databaseURL: "https://crono-rrb-default-rtdb.firebaseio.com",
            projectId: "crono-rrb",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let listaPilotosGlobal = [];

        function tParaMs(t) {
            if (!t || t === "00:00:000") return 0;
            const p = t.split(':');
            if (p.length < 3) return 0;
            return (parseInt(p[0]) * 60000) + (parseInt(p[1]) * 1000) + parseInt(p[2]);
        }

        function msParaT(ms) {
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            const mil = ms % 1000;
            return `${String(min).padStart(2,'0')}:${String(seg).padStart(2,'0')}:${String(mil).padStart(3,'0')}`;
        }

        function renderizar() {
            const filtro = document.getElementById('filtroCat').value;
            db.ref('pilotos').once('value', snapshot => {
                const data = snapshot.val();
                listaPilotosGlobal = [];
                for (let k in data) {
                    const p = data[k];
                    const soma = tParaMs(p.volta1) + tParaMs(p.volta2);
                    listaPilotosGlobal.push({ ...p, totalMs: soma, totalStr: msParaT(soma) });
                }

                const categorias = filtro === "TODAS" ? ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"] : [filtro];
                let html = '';
                categorias.forEach(cat => {
                    let filtrados = listaPilotosGlobal.filter(p => p.categoria === cat).sort((a,b) => a.totalMs - b.totalMs);
                    if (filtrados.length > 0) {
                        html += `<h3>${cat}</h3><table><thead><tr><th>Pos</th><th>Piloto</th><th>V1</th><th>V2</th><th>Total</th></tr></thead><tbody>`;
                        filtrados.forEach((p, i) => {
                            html += `<tr><td>${i+1}º</td><td>${p.piloto}</td><td>${p.volta1}</td><td>${p.volta2}</td><td><strong>${p.totalStr}</strong></td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                });
                document.getElementById('conteudoTabelas').innerHTML = html || "<p>Nenhum registro.</p>";
                document.getElementById('displayEtapa').innerText = localStorage.getItem('etapaFixa') || "SEM ETAPA";
            });
        }

        let seg = 5;
        setInterval(() => {
            const countEl = document.getElementById('countdown');
            if(countEl) {
                countEl.innerText = --seg;
                if (seg <= 0) { renderizar(); seg = 5; }
            }
        }, 1000);

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`RANKING - ${localStorage.getItem('etapaFixa') || 'Geral'}`, 10, 10);
            let y = 20;
            ["PRODUCTION", "SUPER PRODUCTION", "PROTOTIPO", "UTV", "INICIANTE"].forEach(cat => {
                let filtrados = listaPilotosGlobal.filter(p => p.categoria === cat).sort((a,b) => a.totalMs - b.totalMs);
                if (filtrados.length > 0) {
                    doc.text(cat, 10, y);
                    doc.autoTable({
                        startY: y + 5,
                        head: [['Pos', 'Piloto', 'V1', 'V2', 'Total']],
                        body: filtrados.map((p, i) => [`${i+1}º`, p.piloto, p.volta1, p.volta2, p.totalStr])
                    });
                    y = doc.lastAutoTable.finalY + 10;
                }
            });
            doc.save('Ranking.pdf');
        }
        window.onload = renderizar;
    </script>
</body>
</html>