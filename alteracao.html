<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Alterar Tempos - Sistema Crono</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; }
        .card { max-width: 450px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        img { width: 150px; margin-bottom: 20px; }
        h3 { color: #333; margin-bottom: 20px; }
        
        label { display: block; text-align: left; font-size: 14px; color: #555; margin-top: 15px; font-weight: bold; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        input:focus, select:focus { border-color: #f39c12; outline: none; box-shadow: 0 0 5px rgba(243, 156, 18, 0.3); }

        .btn-update { background-color: #f39c12; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 20px; }
        .btn-update:hover { background-color: #e67e22; }
        
        .btn-back { background-color: #6c757d; color: white; border: none; cursor: pointer; transition: 0.3s; }
        .btn-back:hover { background-color: #5a6268; }

        .info-msg { font-size: 12px; color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s" alt="Logo">
        <h3>Alterar Dados do Piloto</h3>

        <label>1. Selecione a Categoria:</label>
        <select id="categoria" onchange="buscarPilotos()">
            <option value="">-- Selecione --</option>
            <option value="PRODUCTION">PRODUCTION</option>
            <option value="SUPER PRODUCTION">SUPER PRODUCTION</option>
            <option value="PROTOTIPO">PROTOTIPO</option>
            <option value="UTV">UTV</option>
            <option value="INICIANTE">INICIANTE</option>
        </select>

        <label>2. Selecione o Piloto:</label>
        <select id="piloto" onchange="preencherTempos()">
            <option value="">-- Selecione a categoria acima --</option>
        </select>

        <label>Tempo Volta 1:</label>
        <input type="text" id="v1" placeholder="00:00:000" maxlength="9">

        <label>Tempo Volta 2:</label>
        <input type="text" id="v2" placeholder="00:00:000" maxlength="9">
        <p class="info-msg">Digite apenas os números, a pontuação é automática.</p>

        <button class="btn-update" onclick="salvarAlteracao()">CONFIRMAR ALTERAÇÃO (SENHA)</button>
        <button class="btn-back" onclick="window.location.href='index.html'">VOLTAR AO INÍCIO</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        // Configuração do seu Banco de Dados
        const firebaseConfig = {
            apiKey: "AIzaSyC4ajZM_W0_qGOlrlRoPn6DUsUBUm4qAcc",
            authDomain: "crono-rrb.firebaseapp.com",
            databaseURL: "https://crono-rrb-default-rtdb.firebaseio.com",
            projectId: "crono-rrb",
            storageBucket: "crono-rrb.firebasestorage.app",
            messagingSenderId: "1472207720",
            appId: "1:1472207720:web:11502aed4117b1fda714dd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dadosCarregados = {};

        // --- LÓGICA DA MÁSCARA AUTOMÁTICA (00:00:000) ---
        const camposTempo = [document.getElementById('v1'), document.getElementById('v2')];
        camposTempo.forEach(input => {
            input.addEventListener('input', function (e) {
                let v = e.target.value.replace(/\D/g, ''); // Remove tudo que não é número
                
                if (v.length > 7) v = v.slice(0, 7); // Limita ao tamanho máximo

                if (v.length > 4) {
                    v = v.replace(/(\d{2})(\d{2})(\d{1,3})/, "$1:$2:$3");
                } else if (v.length > 2) {
                    v = v.replace(/(\d{2})(\d{1,2})/, "$1:$2");
                }
                e.target.value = v;
            });
        });

        // Função para buscar pilotos no Firebase baseada na categoria
        function buscarPilotos() {
            const cat = document.getElementById('categoria').value;
            const selectPiloto = document.getElementById('piloto');
            
            if (!cat) {
                selectPiloto.innerHTML = '<option value="">-- Selecione a categoria --</option>';
                return;
            }

            selectPiloto.innerHTML = '<option value="">Carregando pilotos...</option>';

            db.ref('pilotos').orderByChild('categoria').equalTo(cat).once('value', snapshot => {
                dadosCarregados = snapshot.val() || {};
                selectPiloto.innerHTML = '<option value="">-- Selecione o Piloto --</option>';
                
                let encontrou = false;
                for (let id in dadosCarregados) {
                    encontrou = true;
                    let option = document.createElement('option');
                    option.value = id;
                    option.text = dadosCarregados[id].piloto;
                    selectPiloto.appendChild(option);
                }

                if(!encontrou) {
                    selectPiloto.innerHTML = '<option value="">Nenhum piloto nesta categoria</option>';
                }
            });
        }

        // Preenche os campos de texto ao selecionar um piloto da lista
        function preencherTempos() {
            const id = document.getElementById('piloto').value;
            if (id && dadosCarregados[id]) {
                document.getElementById('v1').value = dadosCarregados[id].volta1;
                document.getElementById('v2').value = dadosCarregados[id].volta2;
            } else {
                document.getElementById('v1').value = "";
                document.getElementById('v2').value = "";
            }
        }

        // Envia as alterações para o Firebase
        function salvarAlteracao() {
            const id = document.getElementById('piloto').value;
            const tempo1 = document.getElementById('v1').value;
            const tempo2 = document.getElementById('v2').value;

            if (!id) {
                alert("Por favor, selecione um piloto.");
                return;
            }

            // Validação mínima de preenchimento do tempo
            if (tempo1.length < 9 || tempo2.length < 9) {
                alert("O tempo deve estar completo no formato 00:00:000");
                return;
            }

            const senha = prompt("Digite a senha de administrador (123456):");
            if (senha === "123456") {
                db.ref('pilotos/' + id).update({
                    volta1: tempo1,
                    volta2: tempo2
                }).then(() => {
                    alert("Dados atualizados com sucesso!");
                    // Opcional: recarregar dados para confirmar
                    buscarPilotos();
                }).catch(err => {
                    alert("Erro ao salvar no banco de dados: " + err);
                });
            } else {
                alert("Senha incorreta! Alteração cancelada.");
            }
        }
    </script>
</body>
</html>